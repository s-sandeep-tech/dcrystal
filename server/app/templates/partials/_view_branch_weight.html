{% if not is_child_rows %}
<table class="enterprise-grid w-full text-[11px] border-collapse bg-white dark:bg-gray-900 sticky-header">
    <thead>
        <tr class="bg-gray-50 dark:bg-gray-800/50 text-gray-500 uppercase font-bold text-[9px] tracking-wider">
            <th class="col-expander text-center px-0 w-8"></th>
            <th class="text-left px-4">Level Detail</th>
            <th class="text-left w-34">Zone</th>
            <th class="text-left">State</th>
            <th class="text-left">Location</th>
            <th class="text-right text-emerald-600">Excess Weight Alloc to <br>Other Shops (OUT)</th>
            <th class="text-right text-indigo-600">Short Stock Reffilled From <br>Other Shops (IN)</th>
        </tr>
    </thead>
    <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
        {% endif %}

        {% for r in rows %}
        <tr class="parent-row hover:bg-blue-50/30 group animate-fade-in" data-level="{{ r.level }}">
            <td class="text-center px-0">
                {% if r.level != 'location' %}
                <button
                    onclick="toggleRow(this, '{{ r.level }}', '{{ r.level == 'zone' and r.zone or r.state }}', '{{ r.level == 'state' and r.zone or '' }}')"
                    class="flex items-center justify-center w-full h-full text-gray-400 group-hover:text-primary transition-colors focus:outline-none">
                    <span class="material-symbols-outlined text-[16px]">add_circle</span>
                </button>
                {% else %}
                <span class="material-symbols-outlined text-[10px] text-gray-200">fiber_manual_record</span>
                {% endif %}
            </td>
            <td class="px-4 font-bold">
                <div class="flex items-center gap-2"
                    style="padding-left: {{ '0px' if r.level == 'zone' else ('20px' if r.level == 'state' else '40px') }}">
                    {% if r.level == 'location' %}
                    <span class="material-symbols-outlined text-[14px] text-gray-300">store</span>
                    {% elif r.level == 'state' %}
                    <span class="material-symbols-outlined text-[14px] text-gray-300">map</span>
                    {% else %}
                    <span class="material-symbols-outlined text-[14px] text-gray-300">public</span>
                    {% endif %}

                    {% if r.level == 'zone' %}
                    {{ r.zone }}
                    {% elif r.level == 'state' %}
                    {{ r.state }}
                    {% else %}
                    {{ r.location }}
                    {% endif %}
                </div>
            </td>
            <td class="text-gray-400 max-w-16 truncate" title="{{ r.zone }}">{{ r.zone }}</td>
            <td class="text-gray-400">{{ r.state or '-' }}</td>
            <td class="text-gray-400">{{ r.location or '-' }}</td>
            <td class="text-right font-medium">
                {% if r.level == 'location' %}
                <a href="javascript:void(0)" onclick="showAllocatedBarcodes('{{ r.location }}', '{{r.max_allocate }}')"
                    class="text-primary hover:underline transition-colors">{{
                    "%.3f"|format(r.max_allocate) }}</a>
                {% else %}
                {{ "%.3f"|format(r.max_allocate) }}
                {% endif %}
            </td>
            <td class="text-right font-medium">
                {% if r.level == 'location' %}
                <a href="javascript:void(0)" onclick="showRefillBarcodes('{{ r.location }}','{{ r.max_refill }}')"
                    class="text-indigo-600 hover:underline transition-colors px-3 py-1.5 block font-bold">{{
                    "%.3f"|format(r.max_refill|float) }}</a>
                {% else %}
                <span class="text-indigo-600/70 px-3 py-1.5 block font-bold">{{ "%.3f"|format(r.max_refill|float)
                    }}</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}

        {% if not rows and not is_child_rows %}
        <tr>
            <td colspan="7" class="p-8 text-center text-gray-400 italic">No data found for the selected filters.</td>
        </tr>
        {% endif %}

        {% if not is_child_rows %}
    </tbody>
    <tfoot class="sticky-footer">
        <tr class="bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white uppercase text-[9px]">
            <td class="p-2 text-right" colspan="5">Grand Total</td>
            <td class="text-right font-bold px-2">{{ "%.3f"|format(footer_totals.max_allocate|float) if
                footer_totals.max_allocate is not none else '0.000' }}</td>
            <td class="text-right font-bold px-2">{{ "%.3f"|format(footer_totals.max_refill|float) if
                footer_totals.max_refill is not none else '0.000' }}</td>
        </tr>
    </tfoot>
</table>

<script id="stats-metadata" type="application/json">
    {{ stats | tojson }}
</script>
<div class="pagination-meta hidden" data-page="{{ pagination.page if pagination else 1 }}"
    data-per-page="{{ pagination.per_page if pagination else 50 }}"
    data-total="{{ pagination.total if pagination else 0 }}"
    data-prev-num="{{ pagination.prev_num if pagination and pagination.has_prev else '' }}"
    data-next-num="{{ pagination.next_num if pagination and pagination.has_next else '' }}"
    data-has-prev="{{ 'true' if pagination and pagination.has_prev else 'false' }}"
    data-has-next="{{ 'true' if pagination and pagination.has_next else 'false' }}" data-level="{{ current_level }}">
</div>
{% endif %}